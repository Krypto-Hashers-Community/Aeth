#!/usr/bin/env bash

# 1. Get the absolute path of the directory where THIS script is located
# This handles cases where you move the whole Aeth folder.
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

# 2. Define relative paths based on that directory
AETH_HOME="$SCRIPT_DIR"
AETH_CONFIG_DIR="$HOME/.config/Aeth"


# 3. Locate the binary, caching the path for faster subsequent launches
CACHE_FILE="$AETH_CONFIG_DIR/binary_path.cache"
BINARY=""

# If cache exists and binary is still valid, use it
if [ -f "$CACHE_FILE" ]; then
    CACHED_PATH=$(cat "$CACHE_FILE")
    if [ -f "$CACHED_PATH" ]; then
        BINARY="$CACHED_PATH"
    fi
fi

# If not cached or cache is invalid, search and update cache
if [ -z "$BINARY" ]; then
    BINARY=$(find "$AETH_HOME/dist-newstyle/build" -type f -name "Aeth" -path "*/x/Aeth/build/Aeth/Aeth" | head -n 1)
    if [ -n "$BINARY" ] && [ -f "$BINARY" ]; then
        echo "$BINARY" > "$CACHE_FILE"
    fi
fi

# Ensure the config directory exists
mkdir -p "$AETH_CONFIG_DIR"

# 4. Execute or Fail
if [ -n "$BINARY" ] && [ -f "$BINARY" ]; then
    # exec replaces the bash process with the Aeth binary
    exec "$BINARY"
else
    echo "Error: Aeth binary not found in $AETH_HOME/dist-newstyle/"
    echo "Please run 'cabal build' inside the project folder first."
    # Remove invalid cache if present
    [ -f "$CACHE_FILE" ] && rm -f "$CACHE_FILE"
    exit 1
fi
